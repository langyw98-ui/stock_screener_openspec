### **股票回测软件模块化需求规格**

**当前版本：** 1.1

**版本更新记录：**
【1.1版本】修正了错误处理机制的描述，明确了数据频率的限制，并更新了项目文件结构。
【1.0版本】初始版本，定义了项目的基础架构、模块职责与核心的数据下载功能。明确了从指定数据源（xtquant）并发获取股票K线数据的完整流程、配置方式和错误处理机制。

#### **一、 项目总体设计与约定 (Overall Project Design & Conventions)**

这部分描述了跨模块的、全局性的设计决策和开发约定。

*   **执行方式**:
    *   程序将作为一个独立的Python脚本集合存在。
    *   主入口文件为 `run.py`。用户通过直接修改此脚本中的变量（如时间范围、数据频率）和 `config.yaml` 配置文件来控制程序行为。
    *   通过IDE的“运行”功能来执行，不开发复杂的命令行接口或图形用户界面。

*   **核心库依赖**:
    *   **Pandas**: 项目中所有涉及Excel文件读取的操作，以及K线数据在内存中的最终表示形式，必须且只能使用 `pandas` 库。
    *   **xtquant**: 作为项目唯一指定的数据源接口。
    *   **PyYAML**: 用于解析 `config.yaml` 配置文件。
    *   **tqdm**: 用于在控制台实现数据下载的进度条反馈。

*   **错误处理**:
    *   对于可预见的、会阻断程序核心流程的错误（如配置文件缺失），程序必须立即抛出异常并终止执行，同时在控制台输出清晰、易于理解的错误信息。
    *   对于单个股票数据下载过程中出现的错误（如股票代码无效、网络问题等），程序应记录错误信息并继续处理其他股票，不终止整个程序执行。

---

#### **二、 配置模块 (Configuration Module)**

**职责**: 负责管理所有需要与代码逻辑分离的外部参数，提供一个统一、稳定的配置读取接口供其他模块调用。

*   **1. 配置文件 (`config.yaml`)**:
    *   **文件格式**: 采用 **YAML** 格式 (`.yaml` 后缀)。
    *   **文件位置**: 必须命名为 `config.yaml` 并放置在项目的根目录。
    *   **配置项**:
        *   `excel_path`: (字符串) 定义了存放股票代码的Excel文件的完整或相对路径。
        *   `max_threads`: (整数) 定义了在执行数据下载时，程序可以使用的最大线程数量。

*   **2. 配置加载逻辑 (`stock_backtester/config.py`)**:
    *   **功能**: 实现一个配置加载器，负责解析 `config.yaml` 文件。
    *   **行为**:
        *   启动时读取并解析 `config.yaml`。
        *   将解析出的配置项以变量或类的属性形式暴露给项目的其他部分。
        *   如果 `config.yaml` 文件不存在，或缺少任何一个必要的配置项，必须抛出 `FileNotFoundError` 或 `KeyError` 异常，并附带明确的提示信息。

---

#### **三、 数据下载模块 (Data Download Module)**

**职责**: 作为项目的核心功能模块，负责根据配置和参数，完成从数据源获取股票K线数据的全部流程。该模块的功能将主要由 `engine.py` 和 `xtquant_feed.py` 协作完成。

*   **1. 输入与参数 (Input & Parameters)**
    *   **股票列表获取**:
        *   从**配置模块**获取 `excel_path` 配置。
        *   使用 `pandas` 库读取该Excel文件。文件内必须包含一个名为 `stock_code` 的列，程序将从该列获取所有股票代码。
    *   **时间范围逻辑**:
        *   下载的时间范围由 `run.py` 中设定的 `start_date` 和 `end_date` 变量决定，必须严格遵循以下逻辑进行计算：
            1.  **仅提供 `start_date`**: 下载从 `start_date` 到执行脚本时的当前系统日期的所有数据。
            2.  **仅提供 `end_date`**: 下载从 `end_date` 当天起，向前倒推6个月的数据。
            3.  **`start_date` 和 `end_date` 均未提供**: 下载从执行脚本时的当前系统日期起，向前倒推6个月的数据。
            4.  **`start_date` 和 `end_date` 均提供**: 使用 `start_date` 和 `end_date` 作为精确的下载范围。
    *   **数据频率**:
        *   下载的数据K线频率由 `run.py` 中的 `period` 变量指定。
        *   程序应支持 `1m`, `5m`, `30m`, `1d` 四种频率字符串，其他频率可能导致数据获取失败。

*   **2. 核心处理逻辑 (Core Processing Logic)**
    *   **股票代码处理**:
        *   **格式化**: 在向 `xtquant` 接口请求数据前，必须将从Excel读取的A股代码（如 `600519`, `000001`）转换为 `xtquant` 要求的后缀格式（`600519.SH`, `000001.SZ`）。
        *   **错误处理**: 格式化过程中，如果遇到任何不符合A股6位数字代码规则的输入，应记录错误信息并跳过该股票，继续处理其他股票。
    *   **数据内容定义**:
        *   **K线字段**: 获取的K线数据必须包含以下字段：开盘价(Open), 最高价(High), 最低价(Low), 收盘价(Close), 成交量(Volume), 成交额(Amount)。
        *   **复权方式**: 默认且固定使用**前复权**模式进行数据获取。

*   **3. 执行与输出 (Execution & Output)**
    *   **并发执行**:
        *   必须采用**多线程**技术并发下载不同股票的数据，以提升整体执行效率。
        *   最大并发线程数由**配置模块**提供的 `max_threads` 参数精确控制。
    *   **用户反馈**:
        *   在数据下载的整个过程中，必须在控制台提供一个实时的**进度条**（使用 `tqdm` 库实现），以明确显示任务的完成百分比、已处理项/总项数以及预估剩余时间。
    *   **数据输出/存储**:
        *   本模块中**不负责任何形式的数据持久化存储**。
        *   获取到的每只股票的K线数据将作为一个 `pandas.DataFrame` 对象保存在内存中，整个下载任务完成后，所有数据将作为结果集合返回给调用方（`run.py`），程序运行结束后内存即释放。

---

#### **四、 项目文件结构 (Project File Structure)**

项目必须遵循以下目录和文件结构，以实现清晰的模块化分离。

```
stock_backtester_project/
│
├── stock_backtester/             # 核心逻辑包
│   ├── __init__.py               # 包初始化文件
│   ├── engine.py                 # 核心引擎，负责任务调度和并发执行
│   ├── config.py                 # 配置文件加载模块
│   └── feeds/                    # 数据源相关模块包
│       ├── __init__.py           # 包初始化文件
│       └── xtquant_feed.py       # 封装xtquant数据接口的模块
│
├── data/                         # 用户数据目录
│   └── stock_list.xlsx           # 存放股票代码的Excel文件
│
├── run.py               # 项目主执行文件
├── config.yaml                   # 项目配置文件
├── requirements.txt              # Python依赖列表
└── docs/                         # 文档目录
    └── project_requirements.md   # 项目需求文档
```